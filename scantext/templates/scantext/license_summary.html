{% extends 'scanpipe/base.html' %}
{% load static humanize %}

{% block extrahead %}
  <style>
    {% for mcolor in detected_licenses.match_colors %}{{ mcolor }}{% endfor %}

    .license-match {
      max-height: 90vh;
      white-space: pre-wrap;
      overflow: scroll;
      border: 1px solid #cdcdcd;
      border-radius: 4px;
      color: rgb(14, 16, 26);
      font-size: 18px;
      font-weight: 400;
      cursor: help;
    }

    .panel {
      position: sticky;
      top: 3vh;
    }

    .license-token {
      opacity: 0.6;
    }

    .highlight {
      opacity: 1;
    }

    a {
      display: block;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container is-fullwidth">
  {% include 'scanpipe/includes/navbar_header.html' %}

  {% include 'scantext/includes/license_summary_header.html' with detected_licenses=detected_licenses %}
  <hr class="mx-1">

  <section class="tab-container">
    {% include 'scantext/includes/license_summary_detail.html' with detected_licenses=detected_licenses %}
  </section>

</div>
{% endblock %}

{% block scripts %}
  <script type="text/javascript">
    const detailBtns = document.querySelectorAll('.license-details-btn')
    const panelBlocks = document.querySelectorAll('.license-block')
    const panelBtns = document.querySelectorAll('.card-header-title')
    const tokens = document.querySelectorAll('.license-token')
    const modalCards = document.querySelectorAll('.license-details-modal')
    const closeModalBtns = document.querySelectorAll('.license-details-close-modal')

    detailBtns.forEach((btn, index) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault()
        modalCards.forEach(modalcard => {
          modalcard.style.display= 'none'
        })
        modalCards[index].style.display= 'block'
      })
    })

    // Click on panels => highlight both panel and tokens

    panelBtns.forEach((btn, index) => {
      btn.addEventListener('click', (e) => {
        panelBlocks.forEach(blk => {
          blk.classList.remove('has-background-info')
          blk.classList.remove('has-text-white')
        })

        tokens.forEach((tkn, ind) => {
          tkn.classList.remove('highlight')
          id = tkn.getAttribute('data-id')
          if (id && id == index) {
            tkn.classList.add('highlight')
          }
        })
        panelBlocks[index].classList.add('has-background-info')
      })
    })

    // Click on tokens => highlight both panel and tokens

    tokens.forEach((tkn, index) => {
      tkn.addEventListener('click', (e) => {
        panelBlocks.forEach(blk => {
          blk.classList.remove('has-background-info')
        })
        id = tkn.getAttribute('data-id') 
        tokens.forEach((tn, ind) => {
          tn.classList.remove('highlight')
          tid = tn.getAttribute('data-id')
          if (id && id == tid) {
            tn.classList.add('highlight')
            panelBlocks[tid].classList.add('has-background-info')
          }
        })
      })
    })

    closeModalBtns.forEach((btn, index) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault()
        modalCards[index].style.display = 'none'
      })
    })

  </script>
{% endblock %}